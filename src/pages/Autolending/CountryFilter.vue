<template>
	<div>
		<h3 class="specific-filter-title">
			Countries
		</h3>
		<div class="row collapse">
			<div class="small-6 columns region-list">
				<ul>
					<li v-for="(region, name) in regions" :key="name">
						<button
							class="region-button"
							@click="openRegion = name"
							:aria-pressed="openRegion === name ? 'true' : 'false'"
						>
							{{ name }}
						</button>
					</li>
				</ul>
			</div>
			<div class="small-6 columns">
				<check-list
					v-if="currentRegion && currentRegion.length"
					:key="openRegion"
					:items="currentRegion"
					@change="onChange"
				/>
				<p v-else key="none" class="region-message">
					Pick a region
				</p>
			</div>
		</div>
	</div>
</template>

<script>
import _get from 'lodash/get';
import _groupBy from 'lodash/groupBy';
import _map from 'lodash/map';
import _sortBy from 'lodash/sortBy';
import gql from 'graphql-tag';
import countryListQuery from '@/graphql/query/autolending/countryList.graphql';
import anyOrSelectedAutolendingFilter from '@/plugins/any-or-selected-autolending-filter-mixin';
import CheckList from './CheckList';

export default {
	inject: ['apollo'],
	components: {
		CheckList,
	},
	mixins: [
		anyOrSelectedAutolendingFilter
	],
	data() {
		return {
			allCountries: [],
			currentIsoCodes: [],
			openRegion: '',
		};
	},
	computed: {
		countriesWithSelected() {
			return _map(this.allCountries, ({ isoCode, name, region }) => {
				return {
					id: isoCode,
					name,
					region,
					selected: this.currentIsoCodes.indexOf(isoCode) > -1,
				};
			});
		},
		regions() {
			return _groupBy(this.countriesWithSelected, 'region');
		},
		currentRegion() {
			return _sortBy(_get(this.regions, this.openRegion), 'name');
		},
	},
	apollo: {
		query: countryListQuery,
		preFetch: true,
		result({ data }) {
			this.allCountries = _map(_get(data, 'lend.countryFacets'), 'country') || [];
			this.currentIsoCodes = _get(data, 'autolending.currentProfile.loanSearchCriteria.filters.country') || [];
		},
	},
	methods: {
		onChange(checked, values) {
			// Filter mixin function that calls mutation function
			this.changeCountries(this.getValues(checked, values, this.currentIsoCodes));
		},
		changeCountries(countries) {
			this.apollo.mutate({
				mutation: gql`mutation updateCountries($countries: [String]) {
					autolending @client {
						editProfile(profile: {
							loanSearchCriteria: {
								filters: {
									country: $countries
								}
							}
						})
					}
				}`,
				variables: {
					countries: countries.length ? countries : null,
				}
			});
		}
	},
};
</script>

<style lang="scss" scoped>
@import 'settings';

$section-padding: 0.4rem 0.5rem;

.specific-filter-title {
	font-size: 1rem;
	margin: 0 auto 0.5rem;
	font-weight: $global-weight-highlight;
}

.region-list {
	ul {
		list-style: none;
		margin: 0;
	}
}

p.region-message {
	color: $kiva-text-light;
}

.region-button {
	padding: $section-padding;
	color: $kiva-textlink;
	line-height: 1.8;
	font-size: 1rem;
	text-align: left;

	&:hover {
		color: $kiva-textlink-hover;
		text-decoration: underline;
	}

	&[aria-pressed="true"] {
		color: $kiva-text-light;
		text-decoration: none;
	}
}
</style>
