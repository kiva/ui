import{c as k,o as f,q as c,G as Z,g as d,k as D,b as M,a as p,u,D as A,L as v,z as O,C as R,K as B,M as E}from"./entry-vue.esm-bundler-C0PPCo9W96.js";import{H as T}from"./entry-mdi-B1ONwcTkQ2.js";import{x as j}from"./entry-KvMaterialIcon-C3KLX5OV-L.js";import{S as y,t as m,$ as F,A as N,s as S}from"./entry-KvWwwHeader-C1bm1YMh4q.js";import{k as W}from"./entry-KvBorrowerImage-CeCTvTJdRR.js";import{g as G}from"./entry-KvButton-BA7nBLyz1b.js";import"./entry-numeral-xVHG5DEP0A.js";import{_ as P}from"./iframe-Cc_r_Bkf.js";import{f as K}from"./entry-stringParserUtils-DNVsfKTBwa.js";import{_ as V}from"./entry-_plugin-vue_export-helper-DlAUqK2UKH.js";const J={name:"KvMap",props:{aspectRatio:{type:Number,default:1},autoZoomDelay:{type:Number,default:1500},height:{type:Number,default:null},initialZoom:{type:Number,default:null},lat:{type:Number,default:null},long:{type:Number,default:null},mapId:{type:Number,default:0},useLeaflet:{type:Boolean,default:!1},width:{type:Number,default:null},zoomLevel:{type:Number,default:4},advancedAnimation:{type:Object,required:!1,default:()=>({})},showZoomControl:{type:Boolean,default:!1},allowDragging:{type:Boolean,default:!1},showLabels:{type:Boolean,default:!0},countriesData:{type:Array,default:()=>[]},showFundraisingLoans:{type:Boolean,default:!1},showTooltips:{type:Boolean,default:!0},defaultBaseColor:{type:String,default:null}},data(){return{hasWebGL:!1,leafletReady:!1,mapInstance:null,mapLibreReady:!1,mapLoaded:!1,zoomActive:!1,countriesBorders:{}}},computed:{mapDimensions(){var t;const e=(t=this.$el)==null?void 0:t.getBoundingClientRect(),a=e?`${e.width/this.aspectRatio}px`:"300px",i=e?`${e.width}px`:"100%";return{height:this.height?`${this.height}px`:a,width:this.width?`${this.width}px`:i,paddingBottom:this.height?`${this.height}px`:`${100/this.aspectRatio}%`}},refString(){return`mapholder${this.mapId}`}},watch:{lat(t,e){e===null&&this.long!==null&&!this.mapLibreReady&&!this.leafletReady&&this.initializeMap()},long(t,e){e===null&&this.lat!==null&&!this.mapLibreReady&&!this.leafletReady&&this.initializeMap()},showFundraisingLoans(){this.mapInstance&&(this.mapInstance.remove(),this.initializeLeaflet())}},async mounted(){this.countriesData&&(this.countriesBorders=await P(()=>import("./entry-ne_110m_admin_0_countries.json-BVejQ-SP8P.js"),[],import.meta.url)),!this.mapLibreReady&&!this.leafletReady&&this.initializeMap()},beforeDestroy(){this.mapInstance&&(!this.hasWebGL&&!this.leafletReady&&this.mapInstance.off(),this.mapInstance.remove()),this.destroyWrapperObserver()},methods:{activateZoom(t=!1){const{mapInstance:e,hasWebGL:a,mapLibreReady:i}=this,n=e.getZoom();if(!t&&n===this.zoomLevel||t&&n===this.initialZoom)return!1;this.zoomActive=!0;const l=window.setTimeout(()=>{a&&i?e.zoomTo(t?this.initialZoom:this.zoomLevel,{duration:1200}):e.setZoom(t?this.initialZoom:this.zoomLevel),clearTimeout(l),this.zoomActive=!1},this.autoZoomDelay)},createWrapperObserver(){var t;this.wrapperObserver=this.createIntersectionObserver({targets:[(t=this.$refs)==null?void 0:t[this.refString]],callback:e=>{e.forEach(a=>{var i,n;a.target===((i=this.$refs)==null?void 0:i[this.refString])&&!this.zoomActive&&a.intersectionRatio>0&&(this.initialZoom!==null&&this.activateZoom(),(n=this.advancedAnimation)!=null&&n.borrowerPoints&&this.animateMap())})}})},destroyWrapperObserver(){this.wrapperObserver&&this.wrapperObserver.disconnect()},checkWebGL(){if(this.useLeaflet||typeof document>"u")return!1;const t=document.createElement("canvas"),e=t.getContext("webgl")||t.getContext("experimental-webgl");return e&&e instanceof WebGLRenderingContext?(this.hasWebGL=!0,!0):!1},initializeMap(){const t=document.createElement("script"),e=document.createElement("link");t.setAttribute("async",""),t.setAttribute("defer",""),e.setAttribute("rel","stylesheet"),this.checkWebGL()?(t.setAttribute("vmid",`maplibregljs${this.mapId}`),e.setAttribute("vmid",`maplibreglcss${this.mapId}`),t.setAttribute("src","https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"),e.setAttribute("href","https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css"),this.testDelayedGlobalLibrary("maplibregl").then(a=>{a.loaded&&!this.mapLoaded&&!this.useLeaflet&&this.lat!=null&&this.long!=null&&(this.initializeMapLibre(),this.mapLibreReady=!0)})):(t.setAttribute("vmid",`leafletjs${this.mapId}`),e.setAttribute("vmid",`leaftletcss${this.mapId}`),t.setAttribute("src","https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"),e.setAttribute("href","https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"),this.testDelayedGlobalLibrary("L").then(a=>{a.loaded&&!this.mapLoaded&&this.lat!=null&&this.long!=null&&(this.initializeLeaflet(),this.leafletReady=!0)})),document.head.appendChild(t),document.head.appendChild(e)},initializeLeaflet(){this.mapInstance=L.map(`kv-map-holder-${this.mapId}`,{center:[this.lat,this.long],zoom:this.initialZoom||this.zoomLevel,dragging:this.allowDragging,zoomControl:this.showZoomControl,scrollWheelZoom:!1,doubleClickZoom:!1,attributionControl:!1});let t="https://api.maptiler.com/maps/landscape/{z}/{x}/{y}.png?key=n1Mz5ziX3k6JfdjFe7mx";this.showLabels&&(t="https://api.maptiler.com/maps/bright/{z}/{x}/{y}.png?key=n1Mz5ziX3k6JfdjFe7mx"),L.tileLayer(t,{tileSize:512,zoomOffset:-1,minZoom:1,crossOrigin:!0}).addTo(this.mapInstance),this.countriesData.length>0&&(L.geoJson(this.getCountriesData(),{style:this.countryStyle,onEachFeature:this.onEachCountryFeature}).addTo(this.mapInstance),this.countriesData.forEach(e=>{if(e.numLoansFundraising>0&&this.showFundraisingLoans){const a=L.circle([e.lat,e.long],{color:m.colors.black,weight:1,fillColor:m.colors.brand[900],fillOpacity:1,radius:13e4}).addTo(this.mapInstance),i=`Click to see ${e.numLoansFundraising} fundraising loans in ${e.label}`;a.bindTooltip(i),a.on("click",()=>{this.circleMapClicked(e.isoCode)})}})),this.mapLoaded=!0,this.initialZoom!==null&&this.createWrapperObserver()},initializeMapLibre(){let t="https://api.maptiler.com/maps/landscape/style.json?key=n1Mz5ziX3k6JfdjFe7mx";this.showLabels&&(t="https://api.maptiler.com/maps/bright/style.json?key=n1Mz5ziX3k6JfdjFe7mx"),this.mapInstance=new maplibregl.Map({container:`kv-map-holder-${this.mapId}`,style:t,center:[this.long,this.lat],zoom:this.initialZoom||this.zoomLevel,attributionControl:!1,dragPan:this.allowDragging,scrollZoom:!1,doubleClickZoom:!1,dragRotate:!1}),this.showZoomControl&&this.mapInstance.addControl(new maplibregl.NavigationControl),this.mapInstance.on("load",()=>{var e;this.mapLoaded=!0,(this.initialZoom!==null||(e=this.advancedAnimation)!=null&&e.borrowerPoints)&&this.createWrapperObserver()})},animateMap(){this.mapInstance.style.stylesheet.layers.forEach(t=>{t.type==="symbol"&&this.mapInstance.removeLayer(t.id)}),F(this.mapInstance,this.advancedAnimation.borrowerPoints),setTimeout(()=>{N(this.mapInstance,this.advancedAnimation.borrowerPoints).then(()=>{this.mapInstance.dragPan.enable(),this.mapInstance.scrollZoom.enable(),this.mapInstance.scrollZoom.enable(),this.mapInstance.easeTo({center:[this.long,this.lat],zoom:this.initialZoom||this.zoomLevel})})},500)},checkIntersectionObserverSupport(){return!(typeof window>"u"||!("IntersectionObserver"in window)||!("IntersectionObserverEntry"in window)||!("intersectionRatio"in window.IntersectionObserverEntry.prototype))},createIntersectionObserver({callback:t,options:e,targets:a}={}){if(this.checkIntersectionObserverSupport()){const i=new IntersectionObserver(t,e);return a.forEach(n=>i.observe(n)),i}},testDelayedGlobalLibrary(t,e=3e3){return new Promise((a,i)=>{typeof window>"u"&&i(new Error("window object not available"));let n;const l=window.setInterval(()=>{typeof window[t]<"u"&&(clearInterval(l),clearTimeout(n),a({loaded:!0}))},100);n=window.setTimeout(()=>{clearInterval(l),clearTimeout(n),a({loaded:!1})},e)})},getCountriesData(){const t=this.countriesBorders.features??[];return t.forEach((e,a)=>{const i=this.countriesData.find(n=>n.isoCode===e.properties.iso_a2);i&&(t[a].lenderLoans=i.value,t[a].numLoansFundraising=i.numLoansFundraising)}),this.countriesBorders},countryStyle(t){return{color:m.colors.white,fillColor:y(t.lenderLoans,this.countriesData,m,this.defaultBaseColor),weight:1,fillOpacity:1}},onEachCountryFeature(t,e){if(!this.showTooltips)return;const a=t.lenderLoans?`${t.lenderLoans} loan${t.lenderLoans>1?"s":""}`:"0 loans",i=`${t.properties.name} <br/> ${a}`;e.bindTooltip(i,{sticky:!0}),e.on({mouseover:this.highlightFeature,mouseout:this.resetHighlight})},highlightFeature(t){t.target.setStyle({fillColor:m.colors.gray[500]})},resetHighlight(t){const e=t.target,{feature:a}=e;e.setStyle({fillColor:y(a.lenderLoans,this.countriesData,m,this.defaultBaseColor)})},circleMapClicked(t){this.$emit("country-lend-filter",t)}}},X=["id"];function H(t,e,a,i,n,l){return f(),k("div",{class:"tw-relative tw-block tw-w-full",style:Z(l.mapDimensions)},[c("div",{id:`kv-map-holder-${a.mapId}`,ref:l.refString,class:"tw-w-full tw-h-full tw-bg-black",style:{position:"absolute"}},null,8,X)],4)}const q=S(J,[["render",H]]),Y={class:"tw-w-full tw-relative tw-rounded tw-shadow tw-p-2 tw-flex tw-flex-col tw-bg-white tw-shrink-0 tw-overflow-hidden tw-h-full tw-select-none"},Q={class:"tw-inline-flex tw-items-center tw-gap-1 tw-mb-2 tw-rounded-md tw-bg-eco-green-1 tw-px-1.5 tw-py-0.5 tw-absolute tw-top-2.5 tw-left-2.5 tw-z-1"},U={class:"tw-relative tw-flex tw-justify-center tw-z-1"},tt={class:"tw-flex tw-flex-col tw--mt-3.5 tw-justify-between tw-grow"},et={class:"tw-font-medium tw-text-base tw-pt-0.5"},I={__name:"MyKivaLatestLoanCard",props:{loan:{type:Object,default:()=>({})}},emits:["open-impact-insight-modal"],setup(t){var w;const e=M("$kvTrackEvent"),a=t,i=((w=m.colors)==null?void 0:w.brand[200])||null,n=d(()=>{var o,s,r,h;return((h=(r=(s=(o=a.loan)==null?void 0:o.geocode)==null?void 0:s.country)==null?void 0:r.geocode)==null?void 0:h.latitude)||0}),l=d(()=>{var o,s,r,h;return((h=(r=(s=(o=a.loan)==null?void 0:o.geocode)==null?void 0:s.country)==null?void 0:r.geocode)==null?void 0:h.longitude)||0}),z=d(()=>{var o;return((o=a.loan)==null?void 0:o.borrowerCount)>1?"their lives":"their life"}),C=d(()=>{var o;return K((o=a.loan)==null?void 0:o.name)||"this borrower"}),x=d(()=>{var o;return((o=a.loan)==null?void 0:o.name)||""}),_=d(()=>{var o,s;return((s=(o=a.loan)==null?void 0:o.image)==null?void 0:s.hash)||""}),$=d(()=>{var o,s,r,h,g,b;return[{isoCode:((r=(s=(o=a.loan)==null?void 0:o.geocode)==null?void 0:s.country)==null?void 0:r.isoCode)||"",label:((b=(g=(h=a.loan)==null?void 0:h.geocode)==null?void 0:g.country)==null?void 0:b.name)||"",value:100,lat:n.value,long:l.value}]});return D(()=>{e("portfolio","view","next-step-impact-education")}),(o,s)=>{const r=B("kv-track-event");return f(),k("div",Y,[c("span",Q,[p(u(j),{class:"tw-w-2 tw-h-2 tw-shrink-0",icon:u(T)},null,8,["icon"]),s[1]||(s[1]=c("span",{class:"tw-text-primary tw-font-medium tw-align-middle",style:{"font-size":"0.875rem"}}," Your latest loan ",-1))]),p(u(q),{class:"tw-rounded tw-overflow-hidden !tw-pb-0 tw-z-base",style:{height:"165px"},"use-leaflet":!0,lat:n.value,long:l.value,"zoom-level":2.5,"allow-dragging":!1,"show-labels":!1,"countries-data":$.value,"default-base-color":u(i),"show-tooltips":!1},null,8,["lat","long","countries-data","default-base-color"]),c("div",U,[p(u(W),{class:"bp-image tw-object-cover tw-rounded-full tw-border-4 tw-border-white tw-absolute tw--top-5 tw-drop-shadow-md",alt:x.value,hash:_.value,"aspect-ratio":1/1,"default-image":{width:80,faceZoom:50},images:[{width:80,faceZoom:50}],"photo-path":o.$appConfig.photoPath},null,8,["alt","hash","photo-path"])]),c("div",tt,[c("div",null,[c("h3",null," Step closer to "+v(C.value)+" story ",1),c("p",et," See how your loan improves "+v(z.value)+". ",1)]),A((f(),O(u(G),{variant:"secondary",class:"tw-w-full tw-mt-1",onClick:s[0]||(s[0]=h=>o.$emit("open-impact-insight-modal"))},{default:R(()=>s[2]||(s[2]=[E(" View impact insights ")]),void 0),_:1,__:[2]})),[[r,["portfolio","click","next-step-impact-education"]]])])])}}},mt=V(I,[["__scopeId","data-v-f422f95e"]]);I.__docgenInfo={exportName:"default",displayName:"MyKivaLatestLoanCard",description:"",tags:{},props:[{name:"loan",type:{name:"object"},defaultValue:{func:!1,value:"{}"}}],events:[{name:"open-impact-insight-modal"}],sourceFiles:["/home/runner/work/ui/ui/src/components/MyKiva/MyKivaLatestLoanCard.vue"]};export{mt as M};
